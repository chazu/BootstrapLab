<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>OROM/SVG</title>
    <style>
    svg circle:hover {
      fill: lightgreen;
    }
    svg line {
      stroke-width: 2;
      stroke-opacity: 1;
      pointer-events: none;
      visibility: visible;
    }
    svg line.arrow {
      visibility: visible;
    }
    svg rect {
      stroke: white;
      shape-rendering: crispEdges;
    }
    textarea {
      background: lightgray;
    }
    svg foreignObject {
      pointer-events: none;
    }
    textarea {
      pointer-events: all;
      font-size: 11px;
      font-family: 'Courier New';
    }
    </style>
  </head>
  <body>
    <svg>
      <g id="box-1" class="root" transform="translate(0,0)">
        <g id="next-id">19</g>
        <rect fill="black" x="0" y="0" width="1348.3799999999999" height="963.27"></rect>
        <text font-family="Arial Narrow" x="5" y="20" fill="white">root</text>
        <g id="box-2" class="vtable-vtable" transform="translate(21,55)">
          <rect fill="grey" height="338" width="443"></rect>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">vtable-vtable</text>
          <g id="box-3" class="vtable" transform="translate(11,45)">
            <rect fill="grey" height="46" width="229"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">vtable</text>
            <g transform="translate(203,27)">
              <circle r="10" fill="white" stroke="black" id="circle-13">circle-14</circle>
            </g>
          </g>
          <g id="box-4" class="parent" transform="translate(254,48)">
            <rect fill="grey" height="40" width="181"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">parent</text>
            <g transform="translate(158,25)">
              <circle r="10" fill="white" stroke="black" id="circle-1">circle-2</circle>
            </g>
          </g>
          <g id="box-5" class="methods" transform="translate(13,105)">
            <rect fill="grey" height="222" width="413"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">methods</text>
            <g id="box-6" class="add-method" transform="translate(10,42)">
              <rect fill="grey" height="169" width="393"></rect>
              <text font-family="Arial Narrow" x="5" y="20" fill="white">add-method</text>
              <foreignObject x="5" y="30" width="100%" height="100%">
                <textarea style="width: 373px; height: 127px;">(rcv, name, code) =&gt; {
  let methods = path_lookup(rcv, 'methods');
  let box = path_lookup(methods, name);
  if (box === undefined)
    box = append_new_box(methods, name);
  else box = svg_userData(box);
  let ta = box.svg.textarea;
  ta.value = ta.textContent = code;
}</textarea>
              </foreignObject>
            </g>

          </g>
          <circle id="circle-12" cx="440" cy="79"></circle>
          <circle id="circle-14" cx="234" cy="81"></circle>
        </g>
        <g id="box-8" class="object-vtable" transform="translate(477,12)" clip-path="url(#clip-8)">
          <clipPath id="clip-8">
            <use href="#rect-8" />
          </clipPath>
          <rect id="rect-8" fill="grey" height="183" width="405"></rect>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">object-vtable</text>
          <g id="box-9" class="vtable" transform="translate(7,30)">
            <rect fill="grey" height="69" width="112"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">vtable</text>
            <g transform="translate(82,46)">
              <circle r="10" fill="white" stroke="black" id="circle-11">circle-12</circle>
            </g>
          </g>
          <g id="box-10" class="parent" transform="translate(128,32)">
            <rect fill="grey" height="66" width="74"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">parent</text>
          </g>
          <circle id="circle-2" cx="515" cy="128"></circle>
          <g id="box-18" class="methods" transform="translate(9,133)">
            <rect fill="grey" height="37" width="386"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">methods</text>
          </g>
        </g>
        <g class="init" transform="translate(902,59)">
          <rect fill="grey" height="794" width="431"></rect>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">init</text>
          <foreignObject x="5" y="30" width="100%" height="100%">
            <textarea style="width: 408px; height: 750px; font-family: 'Arial Narrow'; font-size: 15px;">() =&gt; {
vtable_vtable = path_lookup('vtable-vtable');
vtable_addMethod = get_func(vtable_vtable, 'methods', 'add-method');
object_vtable = follow_arrow(path_lookup(vtable_vtable, 'parent'));

vtable_addMethod(vtable_vtable, 'lookup', `(rcv, name) =&gt; {
  let box = path_lookup(rcv, 'methods', name);
  if (box) {
    let src = svg_userData(box).svg.textarea.value;
    return compile(src);
  } else {
    let par = follow_arrow(path_lookup(rcv, 'parent'));
    return par
      ? orom.send(par, 'lookup', name)
      : undefined;
  }
}`);

vtable_lookup = get_func(vtable_vtable, 'methods', 'lookup');

orom = {}; // IMPORTANT...!
orom.send = get_func('send');
orom.bind = get_func('bind');

alert("We've added 'lookup' to all vtables...");

orom.send(object_vtable, 'add-method', 'say-hello', `(rcv) =&gt; {
  console.log("Hello, World! From "+attr(rcv, 'class'));
}`);

alert("We've added 'say-hello' to all objects...");

orom.send(object_vtable, 'say-hello');

console.log('Init finished');
}</textarea>
          </foreignObject>
        </g>
        <g class="send" transform="translate(570,511)">
          <rect fill="grey" height="108" width="323"></rect>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">send</text>
          <foreignObject x="5" y="30" width="100%" height="100%">
            <textarea style="width: 299px; height: 59px;">(rcv, selector, ...args) =&gt; {
  let impl = orom.bind(rcv, selector);
  return impl(rcv, ...args);
}</textarea>
          </foreignObject>
        </g>
        <g class="bind" transform="translate(485,629)">
        <rect fill="grey" height="224" width="409"></rect>
        <text font-family="Arial Narrow" x="5" y="20" fill="white">bind</text>
        <foreignObject x="5" y="30" width="100%" height="100%">
          <textarea style="width: 392px; height: 177px;">(rcv, selector) =&gt; {
  if (rcv === vtable_vtable
      &amp;&amp; selector === 'lookup') {
    return vtable_lookup(rcv, selector);
  } else {
    let vtable = follow_arrow(
      path_lookup(rcv, 'vtable')
    );
    return orom.send(vtable, 'lookup', selector);
  }
}</textarea>
          </foreignObject>
        </g>
      </g>
    </svg>
    <script src="orom-svg.js"></script>
    <script type="text/javascript">
      //get_func('init')();
    </script>
  </body>
</html>
